import os
import asyncio
from textwrap import dedent
from datetime import timedelta

from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode, ChatAction
from aiogram.client.default import DefaultBotProperties
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from aiogram.filters import CommandStart, Command

from aiohttp import web
from aiogram.webhook.aiohttp_server import SimpleRequestHandler

# ===========================
# ENV VARS (Render/Railway)
# ===========================
BOT_TOKEN = os.getenv("BOT_TOKEN")  # set in host dashboard
PUBLIC_BASE_URL = os.getenv("PUBLIC_BASE_URL")  # e.g. https://magnus-bot.onrender.com
WEBHOOK_SECRET = os.getenv("WEBHOOK_SECRET", "magnus-secret")
WEBHOOK_PATH = f"/tg/{WEBHOOK_SECRET}"
PORT = int(os.getenv("PORT", "8000"))

if not BOT_TOKEN or not PUBLIC_BASE_URL:
    raise RuntimeError("BOT_TOKEN and PUBLIC_BASE_URL must be set as environment variables.")

# ===========================
# BOT + DISPATCHER
# ===========================
bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.MARKDOWN)
)
dp = Dispatcher()

# ===========================
# Content: IMAGES / ANIMS
# ===========================
IMAGES = {
    "what_is": "https://magnuswebsite.site/img/magnus_resell.jpg",
    "features": "https://magnuswebsite.site/img/magnus_wealth.jpg",
    "register": "https://magnuswebsite.site/img/magnus_register.jpg",
}
ANIMS = {
    # optional celebratory animation (replace with your own hosted .gif/.mp4 if you like)
    "celebrate": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYjM3YzA5MGQ2M2ZkMDk0M2I5NTRmOWQxM2EwYWFkZjFjYTcxY2Y5MiZjdD1n/26gslU06gXJ5a9aYs/giphy.gif"
}

# ===========================
# Features & Earnings (new)
# ===========================
MAGNUS_UNIQUE = dedent("""\
‚ñ´ *Magnus offers thousands of digital products* you can access anytime.  
‚ñ´ Some products are usable *immediately*, others need deeper study‚Äî*you choose*.  
‚ñ´ Some skills take *minutes*, others *months*‚Äî*your pace, your path*.  
‚ñ´ Learn *multiple* skills to increase your income.  
‚ñ´ The *more skills* you learn and the *more time* you work, the *more you earn*.  
‚ñ´ Become a *digital retailer* and earn *millions monthly* (no referrals required).  
‚ñ´ Withdraw via *PayPal*, *USDT*, or *local bank account*.  
‚ñ´ *100% refundable* entry fee‚Äîcan be recovered within *5 days* of joining.
""")

MAGNUS_EMP_EARNINGS = dedent("""\
*Earnings for Magnus Employees*

‚ë† Gain Valuable Skills  
‚ë° Get Trained  
‚ë¢ Get Employed  
‚ë£ Start Making Money

‚Ä¢ Every *30 minutes* of work: *‚Ç¶2,499*  
‚Ä¢ 1 hour  = *‚Ç¶4,999.8*  
‚Ä¢ 2 hours = *‚Ç¶9,999.6*  
‚Ä¢ 3 hours = *‚Ç¶14,999.4*

‚≠ê Work *6 hours daily* ‚Üí *‚Ç¶29,998.8/day*, *‚Ç¶209,991.6/week*, *‚Ç¶899,964/30 days*

*Pro tip:* Learn *two skills* and multitask to *double your income*:  
‚Ä¢ 1 day:  ‚Ç¶59,997.6  
‚Ä¢ 2 days: ‚Ç¶119,995.2  
‚Ä¢ 3 days: ‚Ç¶179,992.8  
‚Ä¢ 4 days: ‚Ç¶239,990.4

‚ö° You can also become a *digital retailer* and earn *millions monthly*‚Äî*no referrals needed*.
""")

# ===========================
# Section Texts
# ===========================
SECTION_TEXT = {
    "what_is": dedent("""\
        *MAGNUS ‚Äî Your Shortcut to Digital Freedom*

        MAGNUS is a digital marketplace for *in-demand skills* and *powerful products*
        (trading tools, signals, analytics, courses). Use them for *personal growth* or
        *resell for profit*. With flexible plans, instant earning routes, and global job
        offers, MAGNUS helps you *learn, earn, and grow*.
        
        {}
    """).format(MAGNUS_UNIQUE),

    "features": dedent("""\
        *What You Get (Earning Features + Legitimacy)*

        ‚Ä¢ Trading Tools ‚Äî stay ahead in the markets  
        ‚Ä¢ Signals & Analytics ‚Äî make smarter moves  
        ‚Ä¢ Hot Courses ‚Äî learn skills in minutes, not months  
        ‚Ä¢ Resale Rights ‚Äî earn while others are still learning

        *Entry Plans*
        ‚Ä¢ *MAGNUS BUSINESS* ‚Äî ‚Ç¶28,500  
          Unlimited products ‚Ä¢ Full resale rights ‚Ä¢ Create & sell your own ‚Ä¢ Instant job after skills  
          Commissions: Direct ‚Ç¶17,100 | Indirect ‚Ç¶1,300

        ‚Ä¢ *MAGNUS PRO* ‚Äî ‚Ç¶17,500  
          Limited access ‚Ä¢ Low resale rights ‚Ä¢ Learn for growth  
          Earn via PR entry data up to ‚Ç¶985 every 2 minutes (when available)  
          Commissions: Direct ‚Ç¶11,500 | Indirect ‚Ç¶650

        ‚Ä¢ *MAGNUS LITE* ‚Äî ‚Ç¶11,500  
          1 product ‚Ä¢ No resale rights  
          Earn via referrals + data entry up to ‚Ç¶985 every 2 minutes (when available)  
          Commissions: Direct ‚Ç¶7,500 | Indirect ‚Ç¶350

        *Earnings Potential*
        ‚Ä¢ Profit ‚Ç¶5,000+ per sale  
        ‚Ä¢ Company handles ads & logistics  
        ‚Ä¢ Free resale setup manual (1‚Äì72hrs sales cycle)  
        ‚Ä¢ Multiple streams: Skills + Resale + Commissions + Global Jobs

        {}
    """).format(MAGNUS_EMP_EARNINGS),

    "register": dedent("""\
        *How to Register (Simple Steps)*

        1) Choose your entry plan: *Business*, *Pro*, or *Lite*.  
        2) Tap *Register Now*, pick your country, and pay to the displayed account.  
        3) Send your receipt here in chat.  
        4) Get activated and start learning, using products, and earning.

        *Tip:* Start now. The sooner you begin, the faster you unlock skills, resale rights, and job routes.
    """),
}

# ===========================
# Payments (NG updated)
# ===========================
PAYMENT_DETAILS = {
    "NG": dedent("""\
        üá≥üá¨ *Nigeria ‚Äî Bank Transfer (No OPay)*

        ‚Ä¢ *Bank:* Moniepoint MFB  
        ‚Ä¢ *Account Number:* `6054080105`  
        ‚Ä¢ *Account Name:* *SPINO CLINTON UCHENNA*

        üîî *OPay payments are NOT allowed.* Please use *bank transfer* only.

        *One-time Fees:*  
        ‚Ä¢ Magnus Business: ‚Ç¶28,500  
        ‚Ä¢ Magnus Pro: ‚Ç¶17,500  
        ‚Ä¢ Magnus Lite: ‚Ç¶11,500

        *Perks for Paying *Now**:*  
        ‚Ä¢ ‚ö° *Priority Activation* ‚Äî jump the queue  
        ‚Ä¢ üéÅ *Starter Toolkit* ‚Äî quick-start guides + templates  
        ‚Ä¢ üõ°Ô∏è *5-Day Entry Fee Safety* ‚Äî recoverable on terms stated  
        ‚Ä¢ üíº *Fast-Track Jobs* (Business tier) ‚Äî early slot access

        After payment, *send your receipt here* for instant processing.
    """),
    "GH": dedent("""\
        üá¨üá≠ *Ghana ‚Äî Mobile Money*
        ‚Ä¢ Name: REPLACE_ME_MOMO_NAME
        ‚Ä¢ Network: REPLACE_ME_NETWORK
        ‚Ä¢ MoMo Number: REPLACE_ME_MOMO_NUMBER

        *Equivalent Fees:* confirm current rate  
        ‚Ä¢ Business ‚âà NGN 28,500  
        ‚Ä¢ Pro ‚âà NGN 17,500  
        ‚Ä¢ Lite ‚âà NGN 11,500

        Send proof of payment here to proceed.
    """),
    "KE": dedent("""\
        üá∞üá™ *Kenya ‚Äî M-Pesa*
        ‚Ä¢ Name: REPLACE_ME_MPESA_NAME
        ‚Ä¢ Till/PayBill: REPLACE_ME_MPESA_TILL
        ‚Ä¢ Number: REPLACE_ME_MPESA_NUMBER

        *Equivalent Fees:* confirm current rate  
        ‚Ä¢ Business ‚âà NGN 28,500  
        ‚Ä¢ Pro ‚âà NGN 17,500  
        ‚Ä¢ Lite ‚âà NGN 11,500

        Send proof of payment here to proceed.
    """),
    "ZA": dedent("""\
        üáøüá¶ *South Africa ‚Äî EFT*
        ‚Ä¢ Account Name: REPLACE_ME_ACCOUNT_NAME
        ‚Ä¢ Bank: REPLACE_ME_BANK
        ‚Ä¢ Account No: REPLACE_ME_ACCOUNT_NUMBER

        *Equivalent Fees:* confirm current rate  
        ‚Ä¢ Business ‚âà NGN 28,500  
        ‚Ä¢ Pro ‚âà NGN 17,500  
        ‚Ä¢ Lite ‚âà NGN 11,500

        Send proof of payment here to proceed.
    """),
    "INTL": dedent("""\
        üåç *International ‚Äî USD / Wise / PayPal*
        ‚Ä¢ Method: REPLACE_ME_METHOD (e.g., Wise/PayPal)
        ‚Ä¢ Handle/Email: REPLACE_ME_EMAIL_OR_HANDLE

        *Guide (edit to official USD pricing):*  
        ‚Ä¢ Business: $35  
        ‚Ä¢ Pro: $25  
        ‚Ä¢ Lite: $18

        After payment, reply with your receipt to activate access.
    """),
}

# ===========================
# Keyboards
# ===========================
def kb_main_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìò What is MAGNUS", callback_data="sec:what_is")],
        [InlineKeyboardButton(text="üíπ Earning Features + Legitimacy", callback_data="sec:features")],
        [InlineKeyboardButton(text="üìù How to Register", callback_data="sec:register")],
    ])

def kb_register() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üü¢ Register Now", callback_data="register")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Back to Menu", callback_data="back:menu")],
    ])

def kb_countries() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [
            InlineKeyboardButton(text="üá≥üá¨ Nigeria", callback_data="country:NG"),
            InlineKeyboardButton(text="üá¨üá≠ Ghana", callback_data="country:GH"),
        ],
        [
            InlineKeyboardButton(text="üá∞üá™ Kenya", callback_data="country:KE"),
            InlineKeyboardButton(text="üáøüá¶ South Africa", callback_data="country:ZA"),
        ],
        [InlineKeyboardButton(text="üåç International (USD)", callback_data="country:INTL")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Back", callback_data="back:menu")],
    ])

def kb_back_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Back to Menu", callback_data="back:menu")]
    ])

# ===========================
# Helper: Typing ‚Äúanimation‚Äù
# ===========================
async def human_typing(chat_id: int, seconds: float = 1.2):
    await bot.send_chat_action(chat_id, ChatAction.TYPING)
    await asyncio.sleep(seconds)

# ===========================
# Countdown Engine (edits msg)
# ===========================
async def start_countdown(chat_id: int, message_id: int, total_seconds: int = 300):
    """
    Edits the same message with a ticking countdown (every 10s).
    Telegram rate limits apply; 10s steps are friendly.
    """
    step = 10
    remain = total_seconds
    while remain > 0:
        m, s = divmod(remain, 60)
        timer = f"{m:01d}:{s:02d}"
        try:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=dedent(f"""\
                    ‚è≥ *Secure your perks by completing payment now*

                    ‚Ä¢ *Priority Activation* ‚Äî jump the queue  
                    ‚Ä¢ *Starter Toolkit* ‚Äî guides & templates  
                    ‚Ä¢ *5-Day Entry Fee Safety*  
                    ‚Ä¢ *Fast-Track Jobs* (Business tier)

                    *Nigeria ‚Äî Pay via Bank Transfer (No OPay)*  
                    *Bank:* Moniepoint MFB  
                    *Acct:* `6054080105`  
                    *Name:* *SPINO CLINTON UCHENNA*

                    Time left to lock perks: *{timer}*
                    _After transfer, send your receipt here for instant processing._
                """),
                reply_markup=kb_back_menu()
            )
        except Exception:
            # If message was changed by user actions or edited too fast, ignore.
            pass
        await asyncio.sleep(step)
        remain -= step

    # Final nudge
    try:
        await bot.edit_message_text(
            chat_id=chat_id,
            message_id=message_id,
            text=dedent("""\
                ‚úÖ *Timer ended.*

                You can still complete payment to join MAGNUS ‚Äî but *priority perks* may no longer apply.
                
                *Nigeria ‚Äî Bank Transfer (No OPay)*  
                *Bank:* Moniepoint MFB  
                *Acct:* `6054080105`  
                *Name:* *SPINO CLINTON UCHENNA*

                _Send your receipt here to activate your access._
            """),
            reply_markup=kb_back_menu()
        )
        # Optional little celebration animation when they reply with proof (handled manually by you),
        # but we can pre-warm with a friendly animation here:
        await bot.send_animation(chat_id, ANIMS["celebrate"])
    except Exception:
        pass

# ===========================
# Handlers
# ===========================
@dp.message(CommandStart())
async def on_start(message: types.Message):
    await human_typing(message.chat.id, 1.0)
    text = dedent(f"""\
        *Welcome to MAGNUS!*
        This bot will guide you through:
        ‚Ä¢ What MAGNUS is
        ‚Ä¢ Earning Features + Legitimacy
        ‚Ä¢ How to Register (with your country‚Äôs payment details)

        üëâ Tap the Telegram *Start* button to begin, then choose an option below.
        Need help? Reply here and we‚Äôll assist you.
    """)
    await message.answer(text, reply_markup=kb_main_menu())

@dp.message(Command("menu"))
async def on_menu(message: types.Message):
    await message.answer("Choose a section:", reply_markup=kb_main_menu())

async def show_section(chat_id: int, key: str):
    await human_typing(chat_id, 0.8)
    caption = SECTION_TEXT[key] + "\n\n" + "_Tap the button below to proceed._"
    photo_url = IMAGES.get(key, IMAGES["what_is"])
    await bot.send_photo(
        chat_id=chat_id,
        photo=photo_url,
        caption=caption,
        reply_markup=kb_register()
    )

@dp.callback_query(F.data.func(lambda d: d is not None and (
    d.startswith("sec:") or d == "register" or d.startswith("country:") or d.startswith("back:")
)))
async def on_cb(callback: CallbackQuery):
    data = callback.data or ""
    chat_id = callback.message.chat.id
    await callback.answer()

    if data.startswith("sec:"):
        key = data.split("sec:")[1]
        if key in SECTION_TEXT:
            await show_section(chat_id, key)
        else:
            await bot.send_message(chat_id, "Unknown section.", reply_markup=kb_main_menu())

    elif data == "register":
        await bot.send_message(chat_id, "Select your country to see payment details:", reply_markup=kb_countries())

    elif data.startswith("country:"):
        code = data.split("country:")[1]
        details = PAYMENT_DETAILS.get(code)
        if not details:
            await bot.send_message(chat_id, "Payment details not available yet. Please choose another country.", reply_markup=kb_countries())
            return

        await human_typing(chat_id, 0.8)
        sent = await bot.send_message(chat_id, details, reply_markup=kb_back_menu())

        # Special behavior for Nigeria: start visible countdown + perks lock-in
        if code == "NG":
            # Kick off countdown in background (doesn't block webhook loop)
            asyncio.create_task(start_countdown(chat_id, sent.message_id, total_seconds=300))

    elif data.startswith("back:"):
        await bot.send_message(chat_id, "Back to menu. Choose a section:", reply_markup=kb_main_menu())

# ===========================
# Web server (aiohttp) + webhook
# ===========================
async def on_startup(app: web.Application):
    await bot.set_webhook(
        url=PUBLIC_BASE_URL + WEBHOOK_PATH,
        drop_pending_updates=True,
    )

async def on_shutdown(app: web.Application):
    await bot.delete_webhook()

def build_app() -> web.Application:
    app = web.Application()
    app.on_startup.append(on_startup)
    app.on_shutdown.append(on_shutdown)

    # Route only the webhook path to aiogram
    SimpleRequestHandler(dispatcher=dp, bot=bot, secret_token=None).register(app, path=WEBHOOK_PATH)

    # Optional health check
    async def health(_):
        return web.Response(text="OK")
    app.router.add_get("/", health)

    return app

if __name__ == "__main__":
    web.run_app(build_app(), port=PORT)
